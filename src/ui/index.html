<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Owner Dashboard</title>
    <style>
      :root {
        color-scheme: dark;
        font-family: Arial, sans-serif;
      }

      body {
        margin: 0;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #0f172a;
        color: #e2e8f0;
      }

      main {
        width: min(980px, calc(100% - 2rem));
        border: 1px solid #334155;
        border-radius: 12px;
        padding: 1.5rem;
        background: #111827;
      }

      h1 {
        margin-top: 0;
        margin-bottom: 0.25rem;
      }

      p {
        color: #cbd5e1;
      }

      .panel {
        margin-top: 1.25rem;
        border: 1px solid #334155;
        border-radius: 10px;
        padding: 1rem;
        background: #0b1220;
      }

      .panel h2 {
        margin: 0 0 0.75rem;
        font-size: 1rem;
        color: #bfdbfe;
      }

      dl {
        margin: 0;
        display: grid;
        grid-template-columns: 180px 1fr;
        row-gap: 0.5rem;
      }

      dt {
        color: #93c5fd;
      }

      dd {
        margin: 0;
        color: #e2e8f0;
        word-break: break-word;
      }

      .status-message {
        margin-top: 1rem;
        min-height: 1.5rem;
      }

      .status-message.offline {
        color: #fca5a5;
      }

      .screener-form {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 0.75rem;
      }

      .field {
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
      }

      .field label {
        color: #93c5fd;
      }

      .field input,
      .field select {
        border: 1px solid #334155;
        border-radius: 6px;
        background: #0f172a;
        color: #e2e8f0;
        padding: 0.5rem;
      }

      .form-actions {
        grid-column: span 2;
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .form-actions button {
        border: 1px solid #2563eb;
        border-radius: 6px;
        background: #1d4ed8;
        color: #ffffff;
        padding: 0.5rem 0.85rem;
        cursor: pointer;
      }

      .form-actions button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .loading-indicator {
        color: #bfdbfe;
      }

      .error-box {
        margin-top: 0.75rem;
        border: 1px solid #dc2626;
        border-radius: 6px;
        padding: 0.75rem;
        background: rgba(127, 29, 29, 0.35);
        color: #fecaca;
        white-space: pre-wrap;
        word-break: break-word;
      }

      .table-wrap {
        margin-top: 0.9rem;
        overflow-x: auto;
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      th,
      td {
        border-bottom: 1px solid #334155;
        padding: 0.55rem;
        text-align: left;
      }

      th button {
        border: 0;
        background: transparent;
        color: #93c5fd;
        font-weight: 600;
        padding: 0;
        cursor: pointer;
      }

      .muted {
        color: #94a3b8;
      }

      @media (max-width: 700px) {
        .screener-form {
          grid-template-columns: 1fr;
        }

        .form-actions {
          grid-column: span 1;
        }
      }
    </style>
  </head>
  <body>
    <main>
      <h1>Owner Dashboard</h1>
      <p>Trading Engine owner dashboard UI is available at <code>/ui</code>.</p>

      <section class="panel" aria-live="polite">
        <h2>Runtime Status</h2>
        <dl>
          <dt>Status</dt>
          <dd id="status">Loading...</dd>

          <dt>Mode</dt>
          <dd id="mode">Loading...</dd>

          <dt>Runtime ID</dt>
          <dd id="runtime_id">Loading...</dd>

          <dt>Started At</dt>
          <dd id="started_at">Loading...</dd>

          <dt>Updated At</dt>
          <dd id="updated_at">Loading...</dd>
        </dl>
        <p id="status_message" class="status-message"></p>
      </section>

      <section class="panel" aria-live="polite">
        <h2>Screener</h2>
        <form id="screener_form" class="screener-form">
          <div class="field">
            <label for="ingestion_run_id">Ingestion Run ID</label>
            <input id="ingestion_run_id" name="ingestion_run_id" type="text" required />
          </div>

          <div class="field">
            <label for="market_type">Market Type</label>
            <select id="market_type" name="market_type">
              <option value="stock" selected>stock</option>
              <option value="crypto">crypto</option>
            </select>
          </div>

          <div class="field">
            <label for="lookback_days">Lookback Days</label>
            <input
              id="lookback_days"
              name="lookback_days"
              type="number"
              min="1"
              value="200"
              required
            />
          </div>

          <div class="field">
            <label for="min_score">Min Score</label>
            <input id="min_score" name="min_score" type="number" value="30" required />
          </div>

          <div class="form-actions">
            <button id="run_screener_btn" type="submit">Run</button>
            <span id="screener_loading" class="loading-indicator" hidden>Running screener...</span>
          </div>
        </form>

        <div id="screener_error" class="error-box" hidden></div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th><button type="button" data-sort-key="symbol">Symbol</button></th>
                <th><button type="button" data-sort-key="score">Score</button></th>
                <th>
                  <button type="button" data-sort-key="signal_strength">Signal Strength</button>
                </th>
                <th><button type="button" data-sort-key="strategy">Strategy</button></th>
                <th><button type="button" data-sort-key="timeframe">Timeframe</button></th>
                <th><button type="button" data-sort-key="stage">Stage</button></th>
              </tr>
            </thead>
            <tbody id="screener_results_body">
              <tr>
                <td colspan="6" class="muted">No screener results yet.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>
    </main>

    <script>
      (function () {
        const defaults = {
          status: "Unavailable",
          mode: "Unavailable",
          runtime_id: "Unavailable",
          started_at: "Unavailable",
          updated_at: "Unavailable",
        };

        const fields = {
          status: document.getElementById("status"),
          mode: document.getElementById("mode"),
          runtime_id: document.getElementById("runtime_id"),
          started_at: document.getElementById("started_at"),
          updated_at: document.getElementById("updated_at"),
        };

        const statusMessage = document.getElementById("status_message");

        function setValues(values) {
          Object.keys(fields).forEach(function (key) {
            const target = fields[key];
            const rawValue = values[key];
            target.textContent =
              rawValue === undefined || rawValue === null || rawValue === ""
                ? defaults[key]
                : String(rawValue);
          });
        }

        function setMessage(message, isOffline) {
          statusMessage.textContent = message;
          statusMessage.classList.toggle("offline", Boolean(isOffline));
        }

        function parseJsonSafe(response) {
          if (!response.ok) {
            return null;
          }

          return response
            .json()
            .then(function (json) {
              return json;
            })
            .catch(function () {
              return null;
            });
        }

        Promise.all([
          fetch("/health")
            .then(parseJsonSafe)
            .catch(function () {
              return null;
            }),
          fetch("/runtime/introspection")
            .then(parseJsonSafe)
            .catch(function () {
              return null;
            }),
        ])
          .then(function (results) {
            const healthData = results[0] || {};
            const runtimeData = results[1] || {};

            setValues({
              status: healthData.status,
              mode: runtimeData.mode || healthData.mode,
              runtime_id: runtimeData.runtime_id,
              started_at:
                runtimeData.timestamps && runtimeData.timestamps.started_at,
              updated_at:
                runtimeData.timestamps && runtimeData.timestamps.updated_at,
            });

            if (!results[0] && !results[1]) {
              setMessage(
                "Runtime endpoints are currently unavailable. Displaying fallback values.",
                true
              );
            } else if (!results[0] || !results[1]) {
              setMessage(
                "Some runtime details could not be loaded. Showing available data.",
                true
              );
            } else {
              setMessage("Runtime details loaded.", false);
            }
          })
          .catch(function () {
            setValues(defaults);
            setMessage(
              "Runtime endpoints are currently unavailable. Displaying fallback values.",
              true
            );
          });

        const screenerForm = document.getElementById("screener_form");
        const runButton = document.getElementById("run_screener_btn");
        const loadingIndicator = document.getElementById("screener_loading");
        const errorBox = document.getElementById("screener_error");
        const resultsBody = document.getElementById("screener_results_body");
        const sortHeaderButtons = Array.prototype.slice.call(
          document.querySelectorAll("th button[data-sort-key]")
        );

        let resultRows = [];
        let sortState = {
          key: "score",
          direction: "desc",
        };

        function setLoading(isLoading) {
          runButton.disabled = isLoading;
          loadingIndicator.hidden = !isLoading;
        }

        function showError(message) {
          errorBox.textContent = message;
          errorBox.hidden = false;
        }

        function clearError() {
          errorBox.textContent = "";
          errorBox.hidden = true;
        }

        function normalizeNumber(value) {
          const num = Number(value);
          return Number.isFinite(num) ? num : null;
        }

        function getSortValue(row, key) {
          if (key === "score" || key === "signal_strength") {
            const numericValue = normalizeNumber(row[key]);
            if (numericValue !== null) {
              return numericValue;
            }
          }
          if (row[key] === undefined || row[key] === null) {
            return "";
          }
          return String(row[key]).toLowerCase();
        }

        function stableSortRows(rows, key, direction) {
          const directionFactor = direction === "asc" ? 1 : -1;

          return rows
            .map(function (row, index) {
              return { row: row, index: index };
            })
            .sort(function (left, right) {
              const leftValue = getSortValue(left.row, key);
              const rightValue = getSortValue(right.row, key);

              if (leftValue < rightValue) {
                return -1 * directionFactor;
              }
              if (leftValue > rightValue) {
                return 1 * directionFactor;
              }
              return left.index - right.index;
            })
            .map(function (item) {
              return item.row;
            });
        }

        function flattenRows(payload) {
          const symbols = payload && Array.isArray(payload.symbols) ? payload.symbols : [];
          const rows = [];

          symbols.forEach(function (symbolItem) {
            const setups = Array.isArray(symbolItem.setups) ? symbolItem.setups : [];
            setups.forEach(function (setupItem) {
              rows.push({
                symbol: symbolItem.symbol || "",
                score: symbolItem.score,
                signal_strength: symbolItem.signal_strength,
                strategy: setupItem.strategy || "",
                timeframe: setupItem.timeframe || "",
                stage: setupItem.stage || "",
              });
            });
          });

          return rows;
        }

        function renderRows() {
          resultsBody.innerHTML = "";

          if (resultRows.length === 0) {
            const emptyRow = document.createElement("tr");
            const emptyCell = document.createElement("td");
            emptyCell.colSpan = 6;
            emptyCell.className = "muted";
            emptyCell.textContent = "No screener results available.";
            emptyRow.appendChild(emptyCell);
            resultsBody.appendChild(emptyRow);
            return;
          }

          resultRows.forEach(function (row) {
            const tr = document.createElement("tr");
            [
              row.symbol,
              row.score,
              row.signal_strength,
              row.strategy,
              row.timeframe,
              row.stage,
            ].forEach(function (value) {
              const td = document.createElement("td");
              td.textContent =
                value === undefined || value === null || value === "" ? "-" : String(value);
              tr.appendChild(td);
            });
            resultsBody.appendChild(tr);
          });
        }

        function applySorting() {
          resultRows = stableSortRows(resultRows, sortState.key, sortState.direction);
          renderRows();
        }

        function updateSortHeaderLabels() {
          sortHeaderButtons.forEach(function (button) {
            const key = button.getAttribute("data-sort-key");
            const baseLabel = button.textContent.replace(/\s[↑↓]$/, "");
            if (key === sortState.key) {
              button.textContent = baseLabel + (sortState.direction === "asc" ? " ↑" : " ↓");
            } else {
              button.textContent = baseLabel;
            }
          });
        }

        sortHeaderButtons.forEach(function (button) {
          button.addEventListener("click", function () {
            const key = button.getAttribute("data-sort-key");
            if (sortState.key === key) {
              sortState.direction = sortState.direction === "asc" ? "desc" : "asc";
            } else {
              sortState.key = key;
              sortState.direction = key === "score" ? "desc" : "asc";
            }
            applySorting();
            updateSortHeaderLabels();
          });
        });

        function parseErrorPayload(textPayload) {
          if (!textPayload) {
            return "Request failed with empty error response.";
          }
          try {
            const parsed = JSON.parse(textPayload);
            return JSON.stringify(parsed, null, 2);
          } catch (error) {
            return textPayload;
          }
        }

        screenerForm.addEventListener("submit", function (event) {
          event.preventDefault();
          clearError();

          const ingestionRunId = document.getElementById("ingestion_run_id").value.trim();
          const marketType = document.getElementById("market_type").value;
          const lookbackDays = Number(document.getElementById("lookback_days").value);
          const minScore = Number(document.getElementById("min_score").value);

          if (!ingestionRunId) {
            showError("ingestion_run_id is required.");
            return;
          }

          const requestBody = {
            ingestion_run_id: ingestionRunId,
            market_type: marketType,
            lookback_days: lookbackDays,
            min_score: minScore,
          };

          setLoading(true);

          fetch("/screener/basic", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(requestBody),
          })
            .then(function (response) {
              if (!response.ok) {
                return response.text().then(function (errorText) {
                  throw new Error(
                    "Screener request failed (" +
                      response.status +
                      "): " +
                      parseErrorPayload(errorText)
                  );
                });
              }
              return response.json();
            })
            .then(function (payload) {
              resultRows = flattenRows(payload);
              applySorting();
              updateSortHeaderLabels();
            })
            .catch(function (error) {
              showError(error && error.message ? error.message : "Screener request failed.");
            })
            .finally(function () {
              setLoading(false);
            });
        });

        updateSortHeaderLabels();
      })();
    </script>
  </body>
</html>
